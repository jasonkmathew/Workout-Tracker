<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Split Workout Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
        }

        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .auth-container h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .google-btn {
            background: white;
            color: #333;
            border: 2px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto 15px auto;
            width: 100%;
            transition: all 0.3s ease;
        }

        .google-btn:hover {
            background: #f8f9fa;
            border-color: #007AFF;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .divider::before {
            margin-right: 15px;
        }

        .divider::after {
            margin-left: 15px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .auth-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
        }

        .auth-btn:hover {
            background: #0056CC;
        }

        .auth-switch {
            margin-top: 15px;
            color: #666;
        }

        .auth-switch button {
            background: none;
            border: none;
            color: #007AFF;
            cursor: pointer;
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            color: #FF3B30;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.85rem;
            color: #666;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #FF3B30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .user-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .controls {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .week-selector {
            margin-bottom: 15px;
        }

        .week-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .week-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
        }

        .workout-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .workout-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
        }

        .workout-content {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise {
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 0;
        }

        .exercise:last-child {
            border-bottom: none;
        }

        .exercise-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .exercise-info {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
        }

        .exercise-select {
            margin-bottom: 10px;
        }

        .exercise-select select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .sets-grid {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 60px;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .sets-grid label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }

        .sets-grid input.previous-data {
            background: #f5f5f5;
            color: #999;
            border: 1px solid #e0e0e0;
        }

        .sets-grid input.previous-data:focus {
            background: white;
            color: #333;
            border-color: #007AFF;
        }

        .sets-grid input.current-data {
            background: white;
            color: #333;
            border: 2px solid #007AFF;
        }

        .sets-grid input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .previous-note {
            grid-column: 1 / -1;
            font-size: 0.75rem;
            color: #999;
            font-style: italic;
            margin-top: -4px;
        }

        .add-set {
            background: #007AFF;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .remove-set {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .exercise-tips {
            background: #f8f9fa;
            border-left: 3px solid #007AFF;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .exercise-tips h4 {
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #333;
        }

        .exercise-tips p {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.3;
            margin: 0;
        }

        .tempo-key {
            background: #e3f2fd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 3px solid #2196F3;
        }

        .tempo-key h4 {
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #1976D2;
        }

        .tempo-key p {
            font-size: 0.8rem;
            color: #333;
            margin: 2px 0;
        }

        .comments {
            margin-top: 10px;
        }

        .comments label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #666;
        }

        .comments textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
        }

        .rest-day {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .rest-day h2 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #34C759;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .save-indicator.show {
            transform: translateY(0);
            opacity: 1;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #exerciseSearch {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .exercise-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .exercise-list-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .exercise-list-item:hover {
            background-color: #f1f1f1;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .sets-grid {
                grid-template-columns: 35px 1fr 1fr 50px;
                gap: 6px;
            }
            
            .sets-grid input {
                padding: 4px 6px;
                font-size: 0.85rem;
            }

            .logout-btn {
                position: static;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC91rY8_FSfQfXkoFuhT0I_H_fan6VLNe0",
            authDomain: "split-workout-tracker.firebaseapp.com",
            projectId: "split-workout-tracker",
            storageBucket: "split-workout-tracker.firebasestorage.app",
            messagingSenderId: "429001339736",
            appId: "1:429001339736:web:e753739f5c827145c36b2d",
            measurementId: "G-1F6C2R60P7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        window.auth = auth;
        window.db = db;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
    </script>

    <div id="authContainer" class="auth-container">
        <h2 id="authTitle">Welcome to Split Tracker</h2>
        
        <button type="button" class="google-btn" onclick="handleGoogleAuth()">
            <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
        </button>
        
        <div class="divider">or</div>
        
        <form id="authForm" class="auth-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="auth-btn" id="authBtn">Sign In</button>
            <div id="authError" class="error"></div>
        </form>
        <div class="auth-switch">
            <span id="authSwitchText">Don't have an account?</span>
            <button type="button" id="authSwitchBtn">Sign Up</button>
        </div>
    </div>

    <div id="loadingScreen" class="loading" style="display: none;">
        <h2>Loading your workouts...</h2>
    </div>

    <div id="appContainer" class="container" style="display: none;">
        <div class="header">
            <h1>ðŸ’ª Split Workout Tracker</h1>
            <p>2 on â€¢ 1 off â€¢ 2 on â€¢ 1-2 off</p>
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <div class="controls">
            <div class="week-selector">
                <label for="weekSelect">Week</label>
                <select id="weekSelect" onchange="selectWeek(this.value)">
                    <option value="1">Week 1</option>
                    <option value="2">Week 2</option>
                    <option value="3">Week 3</option>
                    <option value="4">Week 4</option>
                    <option value="5">Week 5</option>
                    <option value="6">Week 6</option>
                    <option value="7">Week 7</option>
                    <option value="8">Week 8</option>
                    <option value="9">Week 9</option>
                    <option value="10">Week 10</option>
                    <option value="11">Week 11</option>
                    <option value="12">Week 12</option>
                </select>
            </div>

            <div class="workout-selector">
                <label for="planSelect">Workout Plan</label>
                <select id="planSelect" onchange="selectPlan(this.value)">
                    <option value="upperLower">Upper/Lower Split</option>
                    <option value="custom">New Custom Plan</option>
                </select>
            </div>

            <div class="workout-selector" id="daySelectorContainer">
                <label for="daySelect">Day of the Week</label>
                <select id="daySelect" onchange="showWorkoutForDay(this.value)">
                    <option value="1">Day 1</option>
                    <option value="2">Day 2</option>
                    <option value="3">Day 3</option>
                    <option value="4">Day 4</option>
                    <option value="5">Day 5</option>
                    <option value="6">Day 6</option>
                    <option value="7">Day 7</option>
                </select>
            </div>
        </div>

        <div id="workoutContent" class="workout-content">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <div id="exerciseCatalogModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeExerciseCatalog()">&times;</span>
            <h2>Exercise Catalog</h2>
            <input type="text" id="exerciseSearch" onkeyup="filterExercises()" placeholder="Search for exercises..">
            <div id="exerciseList" class="exercise-list"></div>
        </div>
    </div>

    <div id="saveIndicator" class="save-indicator">Saved âœ“</div>

    <script>
        let currentUser = null;
        let currentWeek = 1;
        let currentWorkout = 'upperA'; // This will now refer to the preset workout key
        let currentPlanType = 'upperLower'; // 'upperLower' or 'custom'
        let currentDay = 1; // For custom plans
        let workoutData = {};
        let customWorkouts = {}; // New object to store custom workout plans
        let isSignUp = false;
        let allExercises = []; // To store all exercises fetched from the API

        // API URL for exercises
        const EXERCISE_API_URL = 'https://exercisedbapi.netlify.app/.netlify/functions/api/exercises';

        // Fetch exercises from the API
        async function fetchExercises() {
            try {
                const response = await fetch(EXERCISE_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allExercises = await response.json();
                console.log('Exercises fetched:', allExercises);
                renderExerciseCatalog(allExercises);
            } catch (error) {
                console.error('Error fetching exercises:', error);
            }
        }

        // Exercise execution tips and tempo explanations
        const exerciseTips = {
            "Incline Press": "Don't arch back, maintain stacked position. Brief pause at bottom. Stop 1-2\" above chest.",
            "Chest Fly": "Focus on expansion during eccentric. Don't force scapular retraction, focus on depression.",
            "Lat Pulldown": "Push elbows forward, think 'stabbing the floor'. Don't arch back. Pull DOWN, not back.",
            "Mid Back Row": "Stay upright, don't arch. Focus on shoulder extension, not retraction.",
            "Lateral Raise": "Think pushing out, not up/down. Keep arms slightly in front of you.",
            "Tricep Pushdown": "Control the eccentric, pause at stretch, squeeze at contraction.",
            "DB Curl": "Can rotate from neutral to supination through concentric for bicep focus.",
            "Leg Curl": "Lean forward from hips to lengthen hamstring. Sit back if reaching failure for more reps.",
            "Leg Extension": "Can lean back & scoot butt up for more rectus femoris activation.",
            "Squat": "Use heel elevation. Stay upright, drive knees forward. Brief pause at bottom.",
            "Adductors": "Set machine as wide as possible to force a stretch.",
            "Calf Raise": "Slightly bend knee on concentric. Hold 60sec loaded stretch after final set.",
            "Abs": "Focus on spinal flexion, not hip movement. Contract core through full range.",
            "Pullover": "Still a pulldown, not row. Stab floor with elbow, focus on scapular depression.",
            "Upper Back Row": "Keep elbows high/abducted. Initiate with shoulder extension into full retraction.",
            "Rear Delt Fly": "Start with full protraction. Think pushing outwards, don't turn into row.",
            "Shoulder Press": "Keep spine neutral, core engaged. Don't arch back or lift chest.",
            "Chest Press (RPS)": "Rest Pause: to failure, rest 20-30 breaths, repeat 3x total rounds.",
            "Lower Chest": "Drive biceps into chest, try to touch inner elbows at peak contraction.",
            "Preacher Curl": "Control eccentric, pause at stretch, hold peak contraction.",
            "Tricep Extension": "Focus on keeping upper arms still, control through full range.",
            "Lying Leg Curl": "Press hips into pad, keep spine neutral. Don't let pad leave contact.",
            "Leg Extension (RPS)": "Rest Pause: to failure, rest 20-30 breaths, repeat 3x total rounds.",
            "Romanian Deadlift": "Drive glutes back, knees over ankles. Think driving back then driving in.",
            "Lunges": "Control descent, brief pause, drive through front heel to return.",
            "Leg Raises": "Move into lumbar flexion to contract core, not just hip flexion."
        };

        const tempoKey = `
            <div class="tempo-key">
                <h4>Tempo Guide (e.g., 3:1:1:1)</h4>
                <p><strong>3</strong> = Eccentric (lowering) seconds</p>
                <p><strong>1</strong> = Pause at stretch/bottom position</p>
                <p><strong>1</strong> = Concentric (lifting) seconds</p>
                <p><strong>1</strong> = Pause at contraction/top</p>
            </div>
        `;

        // Workout definitions
        const workouts = {
            upperA: {
                name: "Upper A",
                exercises: [
                    {
                        name: "Incline Press",
                        sets: "1-2 sets",
                        reps: "6-10 reps",
                        tempo: "3:1:1:1",
                        options: ["Incline DB Press", "Incline Smith Machine", "Incline Barbell", "Incline Press Machine"]
                    },
                    {
                        name: "Chest Fly",
                        sets: "2-3 sets",
                        reps: "8-12 reps",
                        tempo: "3:1:1:1",
                        options: ["Chest Fly Machine", "Seated Cable Fly", "Flat DB Flys"]
                    },
                    {
                        name: "Lat Pulldown",
                        sets: "2-3 sets",
                        reps: "6-10 reps",
                        tempo: "3:1:1:1",
                        options: ["Wide Grip", "Neutral Grip", "Pulldown Machine"]
                    },
                    {
                        name: "Mid Back Row",
                        sets: "2-3 sets",
                        reps: "8-12 reps",
                        tempo: "3:1:1:1",
                        options: ["Seated Machine Row", "Cable Row"]
                    },
                    {
                        name: "Lateral Raise",
                        sets: "2-4 sets",
                        reps: "10-15 reps",
                        tempo: "4:1:1:1",
                        options: ["DB Lateral Raise", "Lateral Raise Machine", "Cable Lateral Raise"]
                    },
                    {
                        name: "Tricep Pushdown",
                        sets: "2-4 sets",
                        reps: "8-12 reps",
                        tempo: "3:2:1:1",
                        options: ["Rope", "V-Bar", "Straight Bar"]
                    },
                    {
                        name: "DB Curl",
                        sets: "2-4 sets",
                        reps: "8-12 reps",
                        tempo: "3:1:1:1",
                        options: ["Alternating DB Curl", "Hammer Curl", "Seated", "Standing"]
                    }
                ]
            },
            lowerA: {
                name: "Lower A",
                exercises: [
                    {
                        name: "Leg Curl",
                        sets: "2-3 sets",
                        reps: "8-12 reps",
                        tempo: "4:1:1:1",
                        options: ["Seated Leg Curl"]
                    },
                    {
                        name: "Leg Extension",
                        sets: "2-3 sets",
                        reps: "8-12 reps",
                        tempo: "3:1:1:1",
                        options: ["Standard", "Leaning Back"]
                    },
                    {
                        name: "Squat",
                        sets: "1-2 sets",
                        reps: "6-10 reps",
                        tempo: "3:1:1:1",
                        options: ["High Bar Back Squat", "Front Squat", "Smith Machine", "Hack Squat"]
                    },
                    {
                        name: "Adductors",
                        sets: "2-3 sets",
                        reps: "10-15 reps",
                        tempo: "3:2:1:1",
                        options: ["Adductor Machine"]
                    },
                    {
                        name: "Calf Raise",
                        sets: "3-5 sets",
                        reps: "10-15 reps",
                        tempo: "3:2:1:2",
                        options: ["Standing Machine", "Donkey", "Leg Press"]
                    },
                    {
                        name: "Abs",
                        sets: "3-5 sets",
                        reps: "10-15 reps",
                        tempo: "3:1:1:1",
                        options: ["Crunch Machine", "Cable Crunches"]
                    }
                ]
            },
            upperB: {
                name: "Upper B",
                exercises: [
                    {
                        name: "Pullover",
                        sets: "2-3 sets",
                        reps: "8-12 reps",
                        tempo: "3:1:1:1",
                        options: ["Cable Pullover", "Machine Pulldown"]
                    },
                    {
                        name: "Upper Back Row",
                        sets: "2-3 sets",
                        reps: "6-10 reps",
                        tempo: "3:1:1:2",
                        options: ["T-Bar Row", "Machine Row", "DB Row"]
                    },
                    {
                        name: "Rear Delt Fly",
                        sets: "2-4 sets",
                        reps: "10-15 reps",
                        tempo: "3:2:1:2",
                        options: ["Machine", "Cable", "DB Fly"]
                    },
                    {
                        name: "Shoulder Press",
                        sets: "1-2 sets",
                        reps: "8-12 reps",
                        tempo: "3:1:1:1",
                        options: ["DB Press", "Smith Machine", "Machine Press"]
                    },
                    {
                        name: "Chest Press (RPS)",
                        sets: "Rest Pause",
                        reps: "10-12 reps",
                        tempo: "3:1:1:1",
                        options: ["Machine Press", "Smith Bench"]
                    },
                    {
                        name: "Lower Chest",
                        sets: "2-3 sets",
                        reps: "10-15 reps",
                        tempo: "3:1:1:1",
                        options: ["Decline Cable", "Cable Fly"]
                    },
                    {
                        name: "Preacher Curl",
                        sets: "2-4 sets",
                        reps: "8-12 reps",
                        tempo: "3:2:1:2",
                        options: ["DB", "Cable", "Machine", "Barbell"]
                    },
                    {
                        name: "Tricep Extension",
                        sets: "2-4 sets",
                        reps: "8-12 reps",
                        tempo: "3:2:1:1",
                        options: ["Skull Crushers", "JM Press"]
                    }
                ]
            },
            lowerB: {
                name: "Lower B",
                exercises: [
                    {
                        name: "Lying Leg Curl",
                        sets: "2-3 sets",
                        reps: "8-12 reps",
                        tempo: "4:2:1:2",
                        options: ["Lying Leg Curl"]
                    },
                    {
                        name: "Leg Extension (RPS)",
                        sets: "Rest Pause",
                        reps: "12-15 reps",
                        tempo: "3:1:1:2",
                        options: ["Standard", "Leaning Back"]
                    },
                    {
                        name: "Romanian Deadlift",
                        sets: "2 sets",
                        reps: "8-12 reps",
                        tempo: "4:1:1:1",
                        options: ["Dumbbells", "Barbell", "Belt Squat"]
                    },
                    {
                        name: "Lunges",
                        sets: "2 sets",
                        reps: "8-12 reps/leg",
                        tempo: "3:1:1:1",
                        options: ["Walking DB", "Split Squat", "Bulgarian", "Leg Press"]
                    },
                    {
                        name: "Calf Raise",
                        sets: "3-5 sets",
                        reps: "8-12 reps",
                        tempo: "3:2:1:2",
                        options: ["Standing Machine", "Donkey", "Leg Press"]
                    },
                    {
                        name: "Leg Raises",
                        sets: "3-5 sets",
                        reps: "AMRAP",
                        tempo: "3:1:1:1",
                        options: ["Hanging", "Machine", "Lying"]
                    }
                ]
            }
        };

        // Authentication functions
        function initAuth() {
            const authForm = document.getElementById('authForm');
            const authSwitchBtn = document.getElementById('authSwitchBtn');

            authForm.addEventListener('submit', handleAuth);
            authSwitchBtn.addEventListener('click', toggleAuthMode);

            // Listen for auth state changes
            window.onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    currentUser = user;
                    showApp();
                    loadUserData();
                } else {
                    currentUser = null;
                    showAuth();
                }
            });
        }

        async function handleGoogleAuth() {
            const errorDiv = document.getElementById('authError');
            
            try {
                const provider = new window.GoogleAuthProvider();
                await window.signInWithPopup(window.auth, provider);
            } catch (error) {
                console.error('Google auth error:', error);
                errorDiv.textContent = error.message;
            }
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            const authTitle = document.getElementById('authTitle');
            const authBtn = document.getElementById('authBtn');
            const authSwitchText = document.getElementById('authSwitchText');
            const authSwitchBtn = document.getElementById('authSwitchBtn');

            if (isSignUp) {
                authTitle.textContent = 'Create Account';
                authBtn.textContent = 'Sign Up';
                authSwitchText.textContent = 'Already have an account?';
                authSwitchBtn.textContent = 'Sign In';
            } else {
                authTitle.textContent = 'Welcome Back';
                authBtn.textContent = 'Sign In';
                authSwitchText.textContent = "Don't have an account?";
                authSwitchBtn.textContent = 'Sign Up';
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            try {
                if (isSignUp) {
                    await window.createUserWithEmailAndPassword(window.auth, email, password);
                } else {
                    await window.signInWithEmailAndPassword(window.auth, email, password);
                }
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        async function handleLogout() {
            try {
                await window.signOut(window.auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userInfo').textContent = `Logged in as: ${currentUser.email}`;

            // Set initial selection for plan and day/workout
            document.getElementById('planSelect').value = currentPlanType;
            if (currentPlanType === 'upperLower') {
                document.getElementById('daySelectorContainer').style.display = 'none';
                document.getElementById('workoutSelect').value = currentWorkout;
                showWorkout(currentWorkout);
            } else {
                document.getElementById('daySelectorContainer').style.display = 'block';
                document.getElementById('daySelect').value = currentDay;
                renderCustomWorkout(currentWeek, currentDay);
            }
        }

        function showLoading() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }



        function initializeWorkoutData() {
            workoutData = {};
            customWorkouts = {};
            for (let week = 1; week <= 12; week++) {
                workoutData[week] = {};
                customWorkouts[week] = {};
                for (let workoutKey in workouts) {
                    workoutData[week][workoutKey] = {};
                    workouts[workoutKey].exercises.forEach((exercise, index) => {
                        workoutData[week][workoutKey][index] = {
                            selectedExercise: exercise.options[0],
                            sets: [{ weight: '', reps: '' }, { weight: '', reps: '' }],
                            comments: ''
                        };
                    });
                }
                for (let day = 1; day <= 7; day++) {
                    customWorkouts[week][day] = []; // Each day starts with an empty array of exercises
                }
            }
        }

        function renderExerciseCatalog(exercises) {
            const exerciseListDiv = document.getElementById('exerciseList');
            exerciseListDiv.innerHTML = '';
            exercises.forEach(exercise => {
                const exerciseItem = document.createElement('div');
                exerciseItem.classList.add('exercise-list-item');
                exerciseItem.textContent = exercise.name; // Assuming exercise object has a 'name' property
                exerciseItem.onclick = () => addExerciseToCustomPlan(exercise);
                exerciseListDiv.appendChild(exerciseItem);
            });
        }

        function openExerciseCatalog() {
            document.getElementById('exerciseCatalogModal').style.display = 'block';
        }

        function closeExerciseCatalog() {
            document.getElementById('exerciseCatalogModal').style.display = 'none';
        }

        function filterExercises() {
            const searchInput = document.getElementById('exerciseSearch').value.toLowerCase();
            const filteredExercises = allExercises.filter(exercise => 
                exercise.name.toLowerCase().includes(searchInput)
            );
            renderExerciseCatalog(filteredExercises);
        }
            const currentCustomDay = customWorkouts[currentWeek][currentDay];
            currentCustomDay.push({
                name: exercise.name,
                sets: [{ weight: '', reps: '' }], // Initialize with one empty set
                comments: ''
            });
            saveUserData();
            renderCustomWorkout(currentWeek, currentDay);
            closeExerciseCatalog();
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            showLoading();
            
            try {
                const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                const userDoc = await window.getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.workouts) {
                        workoutData = userData.workouts;
                    } else {
                        initializeWorkoutData();
                    }
                    if (userData.customWorkouts) {
                        customWorkouts = userData.customWorkouts;
                    } else {
                        // If customWorkouts doesn't exist, initialize it
                        for (let week = 1; week <= 12; week++) {
                            customWorkouts[week] = {};
                            for (let day = 1; day <= 7; day++) {
                                customWorkouts[week][day] = [];
                            }
                        }
                    }
                } else {
                    initializeWorkoutData();
                    await saveUserData();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                initializeWorkoutData();
            }
            
            showApp();
            // Initial display based on current plan type
            if (currentPlanType === 'upperLower') {
                showWorkout(currentWorkout);
            } else {
                showWorkoutForDay(currentDay);
            }
        }

        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                await window.setDoc(userDocRef, {
                    workouts: workoutData,
                    customWorkouts: customWorkouts, // Save custom workouts
                    lastUpdated: new Date()
                }, { merge: true });
                
                showSaveIndicator();
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // App functions
        function selectWeek(week) {
            currentWeek = parseInt(week);
            if (currentPlanType === 'upperLower') {
                showWorkout(currentWorkout);
            } else {
                showWorkoutForDay(currentDay);
            }
        }

        function addExerciseToCustomPlan(exercise) {
            // This will be implemented later
            console.log('Add exercise to custom plan:', exercise);
            closeExerciseCatalog();
        }

        function selectPlan(planType) {
            currentPlanType = planType;
            const daySelectorContainer = document.getElementById('daySelectorContainer');
            if (planType === 'custom') {
                daySelectorContainer.style.display = 'block';
                openExerciseCatalog(); // Open catalog when starting a new custom plan
                showWorkoutForDay(currentDay); // Display the current day for custom plan
            } else {
                daySelectorContainer.style.display = 'none';
                showWorkout(currentWorkout); // Display the preset workout
            }
        }

        function showWorkoutForDay(day) {
            currentDay = parseInt(day);
            document.getElementById('daySelect').value = day;
            renderCustomWorkout(currentWeek, currentDay);
        }

        function renderCustomWorkout(week, day) {
            const content = document.getElementById('workoutContent');
            const exercisesForDay = customWorkouts[week][day];

            if (exercisesForDay.length === 0) {
                content.innerHTML = `
                    <div class="rest-day">
                        <h2>No exercises for Day ${day}</h2>
                        <p>Click 'New Custom Plan' to add exercises.</p>
                        <button onclick="openExerciseCatalog()">Add Exercises</button>
                    </div>
                `;
                return;
            }

            let html = tempoKey;
            exercisesForDay.forEach((exercise, index) => {
                // This part needs to be adapted to how custom exercises are stored
                // For now, a simplified display
                html += `
                    <div class="exercise">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-info">Sets: ${exercise.sets || 'N/A'} â€¢ Reps: ${exercise.reps || 'N/A'}</div>
                        <!-- Add more details or input fields for sets/reps if needed for custom exercises -->
                    </div>
                `;
            });
            content.innerHTML = html;
        }

        function showWorkout(workoutKey) {
            currentWorkout = workoutKey;
            document.getElementById('workoutSelect').value = workoutKey;

            const content = document.getElementById('workoutContent');
            
            if (workoutKey === 'rest1' || workoutKey === 'rest2') {
                content.innerHTML = `
                    <div class="rest-day">
                        <h2>ðŸ›Œ Rest Day</h2>
                        <p>Recovery time - prepare for your next workout!</p>
                    </div>
                `;
                return;
            }

            const workout = workouts[workoutKey];
            let html = tempoKey;
            
            workout.exercises.forEach((exercise, index) => {
                const exerciseData = workoutData[currentWeek][workoutKey][index];
                const previousWeekData = currentWeek > 1 ? workoutData[currentWeek - 1][workoutKey][index] : null;
                const tips = exerciseTips[exercise.name] || "Focus on proper form and controlled movement.";
                
                html += `
                    <div class="exercise">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-info">${exercise.sets} â€¢ ${exercise.reps} â€¢ ${exercise.tempo}</div>
                        
                        <div class="exercise-select">
                            <select onchange="updateExerciseSelection(${index}, this.value)">
                                ${exercise.options.map(option => `
                                    <option value="${option}" ${exerciseData.selectedExercise === option ? 'selected' : ''}>
                                        ${option}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="sets-${index}">
                            ${generateSetsHTML(index, exerciseData, previousWeekData)}
                        </div>
                        
                        <button class="add-set" onclick="addSet(${index})">+ Add Set</button>
                        
                        <div class="exercise-tips">
                            <h4>Execution Tips:</h4>
                            <p>${tips}</p>
                        </div>
                        
                        <div class="comments">
                            <label>Notes</label>
                            <textarea 
                                placeholder="Form notes, improvements, etc..."
                                onchange="updateComments(${index}, this.value)"
                            >${exerciseData.comments}</textarea>
                        </div>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function generateSetsHTML(exerciseIndex, exerciseData, previousWeekData) {
            let html = '';
            
            // Determine how many sets to show (current data or previous data, whichever is more)
            const currentSets = exerciseData.sets.length;
            let maxSets = currentSets; // Start with current sets

            if (currentPlanType === 'upperLower' && previousWeekData) {
                const prevSetsCount = previousWeekData.sets.length;
                maxSets = Math.max(currentSets, prevSetsCount, 2); // Minimum 2 sets for preset
            } else if (currentPlanType === 'custom') {
                maxSets = Math.max(currentSets, 1); // Minimum 1 set for custom
            }
            
            // Ensure we have enough sets in current data
            while (exerciseData.sets.length < maxSets) {
                exerciseData.sets.push({ weight: '', reps: '' });
            }
            
            for (let setIndex = 0; setIndex < maxSets; setIndex++) {
                const currentSet = exerciseData.sets[setIndex] || { weight: '', reps: '' };
                let previousSet = null;
                if (currentPlanType === 'upperLower' && previousWeekData && previousWeekData.sets[setIndex]) {
                    previousSet = previousWeekData.sets[setIndex];
                }
                
                // Use previous week's data as placeholder if current is empty (only for upperLower)
                const weightValue = currentSet.weight !== '' ? currentSet.weight : 
                                  (previousSet && currentWeek > 1 ? previousSet.weight : '');
                const repsValue = currentSet.reps !== '' ? currentSet.reps : 
                                (previousSet && currentWeek > 1 ? previousSet.reps : '');
                
                // Determine input styling based on data source
                const hasCurrentData = currentSet.weight !== '' || currentSet.reps !== '';
                const hasPreviousData = previousSet && (previousSet.weight || previousSet.reps) && currentWeek > 1 && currentPlanType === 'upperLower';
                
                let weightClass = '';
                let repsClass = '';
                let weightPlaceholder = 'Weight';
                let repsPlaceholder = 'Reps';
                
                if (hasCurrentData) {
                    weightClass = 'current-data';
                    repsClass = 'current-data';
                } else if (hasPreviousData && !hasCurrentData) {
                    weightClass = 'previous-data';
                    repsClass = 'previous-data';
                    weightPlaceholder = `Last: ${previousSet.weight || '?'}`;
                    repsPlaceholder = `Last: ${previousSet.reps || '?'}`;
                }
                
                html += `
                    <div class="sets-grid">
                        <label>S${setIndex + 1}</label>
                        <input type="number" 
                               placeholder="${weightPlaceholder}" 
                               value="${weightValue}" 
                               class="${weightClass}"
                               onchange="updateSetData(${exerciseIndex}, ${setIndex}, 'weight', this.value)"
                               onfocus="this.classList.remove('previous-data'); this.classList.add('current-data');">
                        <input type="number" 
                               placeholder="${repsPlaceholder}" 
                               value="${repsValue}"
                               class="${repsClass}"
                               onchange="updateSetData(${exerciseIndex}, ${setIndex}, 'reps', this.value)"
                               onfocus="this.classList.remove('previous-data'); this.classList.add('current-data');">
                        ${setIndex > 0 || currentPlanType === 'custom' ? `<button class="remove-set" onclick="removeSet(${exerciseIndex}, ${setIndex})">Ã—</button>` : '<span></span>'}
                        ${hasPreviousData && !hasCurrentData ? 
                            `<div class="previous-note">Previous week data - click to edit</div>` : ''
                        }
                    </div>
                `;
            }
            
            return html;
        }

        function updateExerciseSelection(exerciseIndex, value) {
            if (currentPlanType === 'upperLower') {
                workoutData[currentWeek][currentWorkout][exerciseIndex].selectedExercise = value;
                saveUserData();
            }
            // For custom plans, the exercise is already selected when added from the catalog
        }

        function updateSetData(exerciseIndex, setIndex, field, value) {
            let targetData;
            if (currentPlanType === 'upperLower') {
                targetData = workoutData[currentWeek][currentWorkout][exerciseIndex];
            } else {
                targetData = customWorkouts[currentWeek][currentDay][exerciseIndex];
            }

            if (!targetData.sets[setIndex]) {
                targetData.sets[setIndex] = { weight: '', reps: '' };
            }
            targetData.sets[setIndex][field] = value;
            
            // Update the input styling to show it's now current data
            const input = event.target;
            input.classList.remove('previous-data');
            input.classList.add('current-data');
            
            saveUserData();
        }

        function updateComments(exerciseIndex, value) {
            if (currentPlanType === 'upperLower') {
                workoutData[currentWeek][currentWorkout][exerciseIndex].comments = value;
            } else {
                customWorkouts[currentWeek][currentDay][exerciseIndex].comments = value;
            }
            saveUserData();
        }

        function addSet(exerciseIndex) {
            let exerciseData;
            if (currentPlanType === 'upperLower') {
                exerciseData = workoutData[currentWeek][currentWorkout][exerciseIndex];
            } else {
                exerciseData = customWorkouts[currentWeek][currentDay][exerciseIndex];
            }
            exerciseData.sets.push({ weight: '', reps: '' });
            
            // Re-render the sets for the specific exercise
            const previousWeekData = currentWeek > 1 && currentPlanType === 'upperLower' ? workoutData[currentWeek - 1][currentWorkout][exerciseIndex] : null;
            document.getElementById(`sets-${exerciseIndex}`).innerHTML = generateSetsHTML(exerciseIndex, exerciseData, previousWeekData);
            saveUserData();
        }

        function removeSet(exerciseIndex, setIndex) {
            let exerciseData;
            if (currentPlanType === 'upperLower') {
                exerciseData = workoutData[currentWeek][currentWorkout][exerciseIndex];
            } else {
                exerciseData = customWorkouts[currentWeek][currentDay][exerciseIndex];
            }
            exerciseData.sets.splice(setIndex, 1);
            
            // Re-render the sets for the specific exercise
            const previousWeekData = currentWeek > 1 && currentPlanType === 'upperLower' ? workoutData[currentWeek - 1][currentWorkout][exerciseIndex] : null;
            document.getElementById(`sets-${exerciseIndex}`).innerHTML = generateSetsHTML(exerciseIndex, exerciseData, previousWeekData);
            saveUserData();
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Initialize the app when page loads
        window.addEventListener('load', () => {
            initAuth();
            fetchExercises(); // Fetch exercises on load
        });
    </script>
</body>
</html>